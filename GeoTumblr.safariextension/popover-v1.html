<!DOCTYPE html>
<html>
<head>
	<title>GeoTumblr Options</title>
	<link rel="stylesheet" href="bootstrap-3.1.1.min.css">
	<link rel="stylesheet" href="font-awesome-4.0.3.css">
	<link rel="stylesheet" href="popover.css">
	<script type="text/javascript" src="jquery-1.11.0.min.js"></script>
	<script type="text/javascript" src="jquery-ui-1.10.4.custom.min.js"></script>
	<script type="text/javascript" src="bootstrap-3.1.1.min.js"></script>
</head>
<body>
	<div id="popover">
	<ul class="nav nav-tabs">
		<li class="active"><a href="#options" data-toggle="tab" title="Options"><i class="fa fa-lg fa-cog"></i></a></li>
		<li><a href="#toolbar" data-toggle="tab" title="Tools"><i class="fa fa-lg fa-wrench"></i></a></li>
		<li><a href="#blogs" data-toggle="tab" title="Blogs"><i class="fa fa-lg fa-list-ol"></i></a></li>
		<!-- <li><a href="#slideshow" data-toggle="tab" title="Slideshow"><i class="fa fa-lg fa-youtube-play"></i></a></li> -->
	</ul>
	<div class="tab-content">
		<div id="options" class="tab-pane active">
			<fieldset>
				<legend><i class="fa fa-pencil-square"></i> Reblog/Edit Form Options</legend>
				<p class="checkbox"><input id="addToQueue" type="checkbox" /><label for="addToQueue">Add to queue when reblogging</label></p>
				<p class="checkbox"><input id="autoSubmit" type="checkbox" /><label for="autoSubmit">Automatically submit form</label></p>
				<p class="checkbox"><input id="newTab" type="checkbox" /><label for="newTab">Form opens in new tab</label></p>
				<p class="checkbox"><input id="autoClose" type="checkbox" /><label for="autoClose">Close tab/window with submit</label></p>
			</fieldset>
			<fieldset>
				<legend><i class="fa fa-eye"></i> Dashboard View Options</legend>
				<p class="checkbox"><input id="hideMyPosts" type="checkbox" /><label for="hideMyPosts">Hide my posts</label></p>
				<p class="checkbox"><input id="hideMyLikes" type="checkbox" /><label for="hideMyLikes">Hide posts I've liked</label></p>
				<p class="checkbox"><input id="hideSuggestions" type="checkbox" /><label for="hideSuggestions">Hide sidebar suggestions</label></p>
				<p class="checkbox"><input id="hideAdult" type="checkbox" /><label for="hideAdult">Hide posts rated "Adult"</label></p>
			</fieldset>
			<fieldset>
				<legend><i class="fa fa-floppy-o"></i> Extension Local Storage</legend>
				<p id="deleteSettingsButton" class="btn btn-default btn-block"><i class="fa fa-trash-o"></i> Delete my settings</p>
			</fieldset>
		</div>
		<div id="toolbar" class="tab-pane">
			<fieldset>
				<legend><i class="fa fa-tags"></i> Tag Tools</legend>
				<p class="text"><label for="findTag">Find:</label><input id="findTag" type="text" value="" /></p>
				<p class="text"><label for="replaceTag">Replace:</label><input id="replaceTag" type="text" value="" /></p>
				<p class="textarea"><label for="addTags">Add tag(s):</label><textarea id="addTags"></textarea></p>
				<p class="textarea"><label for="removeTags">Remove tag(s):</label><textarea id="removeTags"></textarea></p>
			</fieldset>
			<fieldset>
				<legend><i class="fa fa-files-o"></i> Batch Edit</legend>
				<p class="checkbox"><input id="batchEditFwd" type="checkbox" /><label for="batchEditFwd">Batch edit proceeds to next page</label></p>
				<p class="checkbox"><input id="batchEditRev" type="checkbox" /><label for="batchEditRev">Batch edit proceeds to previous page</label></p>
				<p class="checkbox"><input id="autoFnR" type="checkbox" /><label for="autoFnR">Automatically find and replace tags</label></p>
				<p class="checkbox"><input id="autoAdd" type="checkbox" /><label for="autoAdd">Automatically add tag(s)</label></p>
				<p class="checkbox"><input id="autoRemove" type="checkbox" /><label for="autoRemove">Automatically remove tag(s)</label></p>
				<p class="checkbox adv" style="display:none;"><input id="advClose" type="checkbox" /><label for="advClose">...and close tab on submit</label></p>
				<p class="checkbox adv" style="display:none;"><input id="advCrawl" type="checkbox" /><label for="advCrawl">...and crawl entire blog</label></p>
			</fieldset>
		</div>
		<div id="blogs" class="tab-pane">
			<fieldset>
				<legend><i class="fa fa-tumblr-square"></i> Assign my Tumblr blogs to number keys:</legend>
				<ul id="keys" class="list-group"></ul>
				<p id="addBlogButton" class="btn btn-default btn-block"><i class="fa fa-plus"></i> Add a blog</p>
			</fieldset>
		</div>
	</div>
	<li id="blank" class="list-group-item blog open">
		<div class="main">
			<span type="button" class="key"></span>
			<span class="title"></span>
			<span class="button-group">
				<button type="button" class="btn btn-primary btn-xs edit"><i class="fa fa-pencil icon"></i><span class="text">Save</span></button>
				<button type="button" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i></button>
			</span>
		</div>
		<div class="details">
			<p class="text"><label>Username:</label><input class="username" type="text" /></p>
			<p class="textarea"><label>Common tags:<br /><span class="btn btn-default btn-xs sort">Sort <i class="fa fa-caret-right"></i></span></label><textarea class="ctags"></textarea></p>
			<p class="textarea"><label>Always add tags:<br /><span class="btn btn-default btn-xs sort">Sort <i class="fa fa-caret-right"></i></span></label><textarea class="atags"></textarea></p>
		</div>
	</li>
</body>
</html>
<script type="text/javascript" charset="utf-8">

$(document).ready(function() {

	console.log("GeoTumblr Popover Activated!");

	loadGlobalData();
	loadBlogsData();

	$('fieldset:not(.details) input:checkbox').click(function() {
		if (!supportsLocalStorage()) { return false; }
		if ($(this).is(':checked')) {
			localStorage.setItem($(this).attr('id'), "true");
		} else {
			localStorage.setItem($(this).attr('id'), "false");
		}
	});

	$('fieldset:not(.details) input:text').blur(function() {
		if (!supportsLocalStorage()) { return false; }
		localStorage.setItem($(this).attr('id'), $(this).val());
	});

	$('fieldset:not(.details) textarea').blur(function() {
		if (!supportsLocalStorage()) { return false; }
		cleanUpTags($(this), true);
		localStorage.setItem($(this).attr('id'), $(this).val());
	});
	
	$('#bookmark').click(function() {
		safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("setBookmark");
		// safari.self.tabs[0].page.dispatchMessage("setBookmark");
	});

	$('#addBlogButton').click(function() {
		var id = $('#blogs .blog').length;
		if (id < 10) initBlog(id);
		$('#blogs').scrollTop(999999999);
		toggleSortable();
	});

	$('#deleteSettingsButton').click(function() {
		localStorage.clear();
		location.reload();
	});
	
	$('#batchEditFwd').change(function() {
		if ($(this).prop('checked') == true && $('#batchEditRev').prop('checked') == true) {
			$('#batchEditRev').click();
		}
	});
	
	$('#batchEditRev').change(function() {
		if ($(this).prop('checked') == true && $('#batchEditFwd').prop('checked') == true) {
			$('#batchEditFwd').click();
		}
	});

	$('#toolbar input:checkbox').change(function() {
		advancedBatch();
	});

	$('#toolbar input:text, #toolbar textarea').blur(function() {
		advancedBatch();
	});

});

if (window.addEventListener) {
	window.addEventListener("storage", handleStorage, false);
} else {
	window.attachEvent("onstorage", handleStorage);
};

function supportsLocalStorage() {
	try {
		return 'localStorage' in window && window['localStorage'] !== null;
	} catch (e) {
		return false;
	}
}

function handleStorage(e) {
	console.log("Storage Changed!");
	if (!e) { e = window.event; }
}

function clearUnusedBlogsData(n) {
	if (!supportsLocalStorage()) { return false; }
	for (var i = n; i <= 10; i++) {
		localStorage.removeItem("blog"+i+".name");
		localStorage.removeItem("blog"+i+".ctags");
		localStorage.removeItem("blog"+i+".atags");
	};
	if (n==0) { localStorage.removeItem("blogsTotal"); }
}

function saveBlogsData() {
	if (!supportsLocalStorage()) { return false; }
	var total = $('#blogs .blog').length;
	clearUnusedBlogsData(total);
	localStorage.setItem("blogsTotal", total.toString());
	for (var i = 0; i < total; i++) {
		var name = $("#blog"+i+' input.username').val();
		var ctags = $("#blog"+i+' textarea.ctags').val();
		var atags = $("#blog"+i+' textarea.atags').val();
		localStorage.setItem("blog"+i+".name", name);
		localStorage.setItem("blog"+i+".ctags", ctags);
		localStorage.setItem("blog"+i+".atags", atags);
	};
}

function loadGlobalData() {
	if (!supportsLocalStorage()) { return false; }
	$('fieldset:not(.details) input:checkbox').each(function() {
		var val = localStorage.getItem($(this).attr('id'));
		if (val == "true") {
			$(this).prop('checked', true);
		} else {
			$(this).prop('checked', false);
		}
	});
	$('fieldset:not(.details) input:text').each(function() {
		var val = localStorage.getItem($(this).attr('id'));
		if (val) $(this).val(val);
	});
	$('fieldset:not(.details) textarea').each(function() {
		var val = localStorage.getItem($(this).attr('id'));
		if (val) $(this).val(val);
	});
}

function loadBlogsData() {
	if (!supportsLocalStorage()) { return false; }
	var total = parseInt(localStorage.getItem("blogsTotal"));
	if (total > 0) {
		for (var i = 0; i < total; i++) {
			// create a new element
			initBlog(i);
			// get details
			var name = localStorage.getItem("blog"+i+".name");
			var ctags = localStorage.getItem("blog"+i+".ctags");
			var atags = localStorage.getItem("blog"+i+".atags");
			// fill in details
			$('#blog'+i+' .key').text(i+1);
			if (i == 9) $('#blog'+i+' .key').text("0");
			$('#blog'+i+' .title').text(name);
			$('#blog'+i+' input.username').val(name);
			$('#blog'+i+' textarea.ctags').val(ctags);
			$('#blog'+i+' textarea.atags').val(atags);
			$('#blog'+i+' input').blur();
			// close details
			var $myBlog = $('#blog'+i);
			$myBlog.removeClass('open');
			$myBlog.find('.details').hide();
		}
		initSortable();
		$('#blogs').scrollTop(0);
	}
	toggleSortable();
}

function initBlog(id) {
	var newBlog = "blog"+id;
	$('#keys').show();
	$('#blank').clone().attr("id", newBlog).appendTo($('#keys'));
	if (id == 9) {
		$('#'+newBlog+' .key').text("0");
	} else {
		$('#'+newBlog+' .key').text(id+1);
	}
	$('#'+newBlog+' input.username').focus();
	// edit/save button actions
	$('#blog'+id+' .btn.edit').click(function() {
		var $myBlog = $(this).parent().parent().parent();
		if ($myBlog.hasClass('open')) {
			// save
			var user = $myBlog.find('input.username').val().trim();
			if (user != "") {
				$myBlog.find('.title').text(user);
				$myBlog.find('input.username').val(user);
			}
			$myBlog.find('textarea').each(function () {
				cleanUpTags($(this));
			});
			saveBlogsData();
			// close
			$myBlog.removeClass('open');
			$myBlog.find('.details').hide();
		} else {
			// open
			$myBlog.addClass('open');
			$myBlog.find('.details').show();
		}
		toggleSortable();
	});
	// remove button actions
	$('#blog'+id+' .btn.delete').click(function() {
		var $myBlog = $(this).parent().parent().parent();
		$myBlog.remove();
		var total = $('#blogs .blog').length;
		reorderBlogs();
		saveBlogsData();
		toggleSortable();
	});
	// sort button actions
	$('#blog'+id+' .btn.sort').click(function() {
		cleanUpTags($(this).parent().parent().find('textarea'), true);
	});
	// hit return on username saves blog data
	$('#blog'+id+' .username').keydown(function(e) {
		// console.log("keydown "+e.which);
		if (e.which == 13) { // Enter
			var $myBlog = $(this).parent().parent().parent();
			$myBlog.find('.btn.edit').click();
		}
	});
}

var sortableActivated = false;
function initSortable() {
	// $('#keys').sortable("destroy");
	$('#keys').sortable({
		cursor: "move",
		placeholder: "sortable-placeholder",
		forcePlaceholderSize: true,
		start: function(e, ui) {
			ui.placeholder.css("height", ui.item.height()+2+"px");
		},
		change: function(e, ui) {
			var pt = ui.placeholder.offset().top;
			$('#blogs .blog:not(.ui-sortable-helper)').each(function(i) {
				if ($(this).offset().top > pt) var i = i+1;
				$(this).find('.key').text(i+1);
				if (i+1 == 10) $(this).find('.key').text("0");
			});
			var pi = ui.placeholder.index();
			var ii = ui.item.index();
			if (pi < ii) {
				ui.item.find('.key').text(pi+1);
			} else {
				ui.item.find('.key').text(pi);
			}
			if (ui.item.find('.key').text() == 10) ui.item.find('.key').text("0");
		},
		update: function(e, ui) {
			reorderBlogs();
			saveBlogsData();
		}
	});
	sortableActivated = true;
}

function toggleSortable() {
	var tb = $('#blogs .blog').length;
	var to = $('#blogs .blog.open').length;
	if (sortableActivated) {
		if (tb > 1 && to == 0) {
			$('#keys').sortable("enable");
		} else {
			$('#keys').sortable("disable");
		}
	}
	if (tb < 10) {
		$('#addBlogButton').show();
	} else {
		$('#addBlogButton').hide();
	}
}

function reorderBlogs() {
	$('#blogs .blog').each(function(){
		var i = $(this).index();
		if (i == 9) {
			$(this).find('.key').text("0");
		} else {
			$(this).find('.key').text(i+1);
		}
		$(this).attr('id', "blog"+i);
	});
}

function cleanUpTags(el, sort) {
	var $el = el;
	var tags = $el.val().split(',');
	var cleanTags = new Array();
	for (var i = 0; i < tags.length; i++) {
		tags[i] = tags[i].trim();
		if (cleanTags.indexOf(tags[i]) === -1) cleanTags.push(tags[i]);
	}
	if (sort) cleanTags.sort();
	cleanTags = cleanTags.join(', ');
	$el.val(cleanTags);
}

function advancedBatch() {
	var allowAdv = false;
	if ($('#batchEditFwd').prop('checked') == true || $('#batchEditRev').prop('checked') == true) {
		if ($('#findTag').val() != "" && $('#replaceTag').val() != "" && $('#autoFnR').prop('checked')) {
			allowAdv = true;
		} else if ($('#addTags').val() != "" && $('#autoAdd').prop('checked')) {
			allowAdv = true;
		} else if ($('#removeTags').val() != "" && $('#autoRemove').prop('checked')) {
			allowAdv = true;
		}
	}
	if (allowAdv) {
		$('#advClose').parent().show();
	} else {
		$('#advClose').prop('checked', false);
		$('#advClose').parent().hide();
		localStorage.removeItem("advClose");
	}
	if ($('#advClose').prop('checked')) {
		$('#advCrawl').parent().show();
	} else {
		$('#advCrawl').prop('checked', false);
		$('#advCrawl').parent().hide();
		localStorage.removeItem("advCrawl");
	}
}
</script>